import arepa
import os
import sys

pE = Environment( )
c_strInputTaxa				= "../" + arepa.c_strFileTaxids
c_strInputExclude			= arepa.c_strEtc + "exclude"
c_strFileExperiments		= arepa.c_strTmp + "experiments"
c_strFileIDsTXT				= arepa.c_strTmp + "ids.txt"
c_strProgExperiments2IDs	= arepa.c_strSource + "experiments2ids.py"
c_strDir					= arepa.dir( pE )

pE.Dir( arepa.c_strTmp )

#arepa.download( pE, c_strFileExperiments,
#	"http://www.ebi.ac.uk/microarray-as/ae/xml/experiments" )
pE.NoClean( c_strFileExperiments )

arepa.pipe( pE, c_strFileExperiments, c_strProgExperiments2IDs, c_strFileIDsTXT,
	[[True, c_strInputTaxa]] )

setExclude = set(arepa.readcomment( open( c_strInputExclude ) ))

def funcArrayExpressTMP( target, source, env ):
	strT, astrSs = arepa.ts( target, source )
	for strLine in open( astrSs[0] ):
		strID = strLine.strip( ).split( "\t" )[0]
		if strID not in setExclude:
			arepa.sconstruct( env, arepa.c_strData + strID )
pE.Command( "ae.tmp", c_strFileIDsTXT, funcArrayExpressTMP )
