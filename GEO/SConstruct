import arepa
import sfle
import sys
import urllib

c_iMaxTaxa				= 100
c_strSufTXT				= ".txt"
c_strSufXML				= ".xml"
c_strURLLeft			= "http://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=gds&term="
c_strURL				= "ftp://ftp.ncbi.nih.gov/pub/geo/DATA/"
c_strURLGDS				= c_strURL + "SOFT/GDS/"
c_strURLGSE				= c_strURL + "SeriesMatrix/"
c_strURLGPL				= c_strURL + "annotation/platforms/"

c_fileInputInclude		= sfle.d( sfle.c_strDirEtc, "include" )
c_fileInputExclude		= sfle.d( sfle.c_strDirEtc, "exclude" )
c_fileInputTaxIDs		= sfle.d( arepa.path_arepa( ), sfle.c_strDirTmp, "taxids" )

c_hashFiles				= {
	"GDS"					: "gds",
	"GSE"					: "gse",
	"GPL+NOT+GSE+NOT+GSM"	: "gpl"
}

c_fileProgXML2TXT		= sfle.d( sfle.c_strDirSrc, "xml2txt.py" )

pE = DefaultEnvironment( )

#===============================================================================
# Download the lists of GDS, GSE, and GPL IDs
#===============================================================================

setstrOrgs = arepa.taxa( c_fileInputTaxIDs, True )
astrOrgs = sorted( setstrOrgs )[:c_iMaxTaxa]
strURLRight = "[ETYP]+AND+(" + "+OR+".join( map( lambda s: urllib.quote_plus( s ) + \
	"[ORGN]", astrOrgs ) ) + ")&retmax=1000000"
afileTXTs = []
for strSet, strBase in c_hashFiles.items( ):
	strOut = sfle.d( sfle.c_strDirTmp, strBase )
	afileXMLs = sfle.download( pE, c_strURLLeft + strSet + strURLRight, strOut + c_strSufXML,
		False, False )
	NoClean( afileXMLs )
# Process XML into the more compact gds/gse/gpl.txt
	afileCur = sfle.pipe( pE, afileXMLs[0], c_fileProgXML2TXT, strOut + c_strSufTXT,
		[[False, strBase]] )
# Save GDS and GSEs for later
	if strBase != "gpl":
		afileTXTs += afileCur

#===============================================================================
# Pass the IDs from gds/gse/gpl.txt to child directories
#===============================================================================

sfle.sconscript_children( pE, afileTXTs, sfle.scanner( c_fileInputExclude, c_fileInputInclude ),
	1, arepa.c_strProgSConstruct,
	{"c_strURLGDS" : c_strURLGDS, "c_strURLGSE" : c_strURLGSE, "c_strURLGPL" : c_strURLGPL} )
